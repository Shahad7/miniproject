{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogue | Library Management System</title>
    <script src = "{% static 'hello/fuse.js' %}" defer></script>

    <!-- Bootstrap cdn -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- CSS files -->
    <link rel="stylesheet" href="{% static 'hello/style.css' %}">
</head>
<body>
    <header>
        <div class="main-bg cat-bg">
            <div class="header-sec cus-margin">
                <img src="{% static 'hello/images/book-solid.png' %}">
                <nav class="navbar">
                    <a href="{% url 'hello:index' %}">Home</a>
                    <a>Catalogue</a>
                    <a>Services</a>
                    <a>Library Staffs</a>
                    <a>Contact</a>
                    <a href="{% url 'hello:logout' %}">Logout</a>
                    <img class="img1" onclick="openLogin()" 
                    src="{% static 'hello/images/profile.png' %}">
                </nav>
            </div>
            <div class="row1">
                <h1>Welcome</h1>
                <div class="searchbar">
                    <input type="text" id="search" name="search">
                    <button style = "background-color: red; border-style: none;
                    background-color: #cd0000;color: #ffffff;height: 40px;width: 80px;border-radius: 10px;"
                    id="searchButton">Search</button>
                </div>
                
            </div>
        </div>
    </header>

    <!-- Main Contents -->
    <div class="cat-body-con" id="Wrapper">
        <div class="row">
            <div class="col-md-3 col-sm-6 col-xs-12">
                <div class="pad1">
                    <div class="books-block cat">
                        <div class="cus-flex">
                            <img src="{% static 'hello/images/basheer.jpeg' %}" alt="" class="src">
                        </div>
                        <h4>Manthrikappoocha</h4>
                        <h5>Author : Basheer</h5>
                        <p>Stock Left : 3</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-xs-1">
                <div class="pad1">
                    <div class="books-block cat">
                        <div class="cus-flex">
                            <img src="{% static 'hello/images/basheer.jpeg' %}" alt="" class="src">
                        </div>
                        <h4>Manthrikappoocha</h4>
                        <h5>Author : Basheer</h5>
                        <p>Stock Left : 3</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-xs-1">
                <div class="pad1">
                    <div class="books-block cat">
                        <div class="cus-flex">
                            <img src="{% static 'hello/images/basheer.jpeg' %}" alt="" class="src">
                        </div>
                        <h4>Manthrikappoocha</h4>
                        <h5>Author : Basheer</h5>
                        <p>Stock Left : 3</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-xs-1">
                <div class="pad1">
                    <div class="books-block cat">
                        <div class="cus-flex">
                            <img src="{% static 'hello/images/basheer.jpeg' %}" alt="" class="src">
                        </div>
                        <h4>Manthrikappoocha</h4>
                        <h5>Author : Basheer</h5>
                        <p>Stock Left : 3</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-xs-1">
                <div class="pad1">
                    <div class="books-block cat" onclick="openRent()">
                        <div class="cus-flex">
                            <img src="{% static 'hello/images/basheer.jpeg' %}" alt="" class="src">
                        </div>
                        <h4>Manthrikappoocha</h4>
                        <h5>Author : Basheer</h5>
                        <p>Stock Left : 3</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rent-popup -->
    <div class="rent-popup" id="RentBook">
        <div class="popup-content">
            <h4>Do you want to rent this book?</h4>
            <div class="align2">
                <button class="yes">Yes</button>
                <button class="no">No</button>
            </div>
            <div class="align1">
                <img class="img3"  onclick="closeRent()" 
                src="{% static 'hello/images/xmark.png' %}">
            </div>
        </div>
    </div>

    <!-- Rent confirmation popup -->
    <div class="rent-confirm" id="RentConfirm">
        <div class="popup-content">
            <div class="cus-flex">
                <h3>Congratulation!</h3>
            </div>
            <div class="cus-flex">
                <img src="{% static 'hello/images/basheer.jpeg' %}" alt="" class="src">
            </div>
            <div class="cus-flex">
                <h5>Your order against Rent Id: LIB007 has been confirmed</h5>
            </div>
        </div>
    </div>
</body>
<script>
    function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


    const searchBody = document.querySelector('.cat-body-con')
    const input = document.querySelector('#search')
    const searchButton = document.getElementById('searchButton')

    searchButton.addEventListener('click',(e)=>{
    e.stopPropagation()
    let search = input.value;
    searchBody.removeChild(document.querySelector('.row'))
    let row = document.createElement('div')
    row.classList.add('row')
    input.value = ""
    fetch("http://127.0.0.1:8000/retrieve")
    .then(response => response.json())
    .then(data =>{
        console.log(data)
        const options = {
            includeScore : true,
            keys : ['title']                        
        }
        const fuse = new Fuse(data,options)
        let result = fuse.search(search)
        console.log(result)

        for(i in result)
        {
            row.append(addSearchResult(result[i].item.title,result[i].item.author,result[i].item.stock,
            result[i].item.photo,result[i].item.id))
        }
        searchBody.appendChild(row)
    
    })})
         

    function addSearchResult(title,author,stock,photo,id){
       
        let col = document.createElement('div')
        col.classList.add('col-md-4', 'col-sm-6','col-xs-12')
        col.style.marginLeft = '150px'
        col.style.width = '700px'
        let pad = document.createElement('div')
        pad.classList.add('pad1')
        let block = document.createElement('div')
        block.classList.add('books-block')
        let flex = document.createElement('div')
        flex.classList.add('cus-flex')
        let img = document.createElement('img')
        img.classList.add('src')
        if(photo!="")
            img.src = 'uploads/'+photo
        flex.appendChild(img)
        let h4 = document.createElement('h4')
        h4.textContent = title
        let h5 = document.createElement('h5')
        h5.textContent = `Author : ${author}`
        let flex1 = document.createElement('div')
        flex1.classList.add('flex1')
        let p = document.createElement('p')
        p.textContent = `Stock Left : ${stock} `  
        flex1.appendChild(p)
        let rentButton = document.createElement('button')
        rentButton.classList.add('b1')
        rentButton.textContent = "Rent"
        rentButton.setAttribute('id',id)
        rentButton.addEventListener('click',()=>{
        fetch("http://127.0.0.1:8000/rent",{
        method:'POST',
        headers: {
            'Content-Type' : 'application/json',
            'X-CSRFToken' : getCookie('csrftoken')
        },
        body:JSON.stringify({
            'bid':rentButton.getAttribute('id')
         })
        })
    })
        block.append(flex,h4,h5,flex1,rentButton)
        pad.appendChild(block)
        col.appendChild(pad)
        return col
}
       
    function openRent(){
        let popup=document.getElementById("RentBook");
        popup.classList.add("open-login");
        var blur= document.getElementById('Wrapper');
        blur.classList.toggle('active');
    }

    function closeRent(){
        let popup=document.getElementById("RentBook");
        popup.classList.remove("open-login");
        var blur= document.getElementById('Wrapper');
        blur.classList.toggle('active');    
    }
    

</script>
</html>